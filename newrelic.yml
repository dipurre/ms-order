# New Relic Java Agent Configuration
# Documentation: https://docs.newrelic.com/docs/agents/java-agent/configuration/java-agent-configuration-config-file

common: &default_settings
  license_key: '<%= license_key %>'
  app_name: ms-order
  
  # Distributed Tracing
  distributed_tracing:
    enabled: true
  
  # Application Logging
  application_logging:
    # IMPORTANTE: El forwarding automático captura logs ANTES de la ofuscación
    # Por eso lo desactivamos y usamos nuestro propio mecanismo con NewRelicEncoder
    enabled: true
    forwarding:
      # DESACTIVADO: Captura logs SIN ofuscar, no podemos usarlo
      # Los logs se envían a través del NewRelicEncoder con ofuscación
      enabled: false
      max_samples_stored: 10000
    local_decorating:
      # ACTIVADO: Agrega trace.id y span.id a los logs para correlación
      enabled: true
    metrics:
      enabled: true

  # Labels
  labels:
    team: backend
    service: diegoip_ms-order
  
  # Error Collector
  error_collector:
    enabled: true
    ignore_status_codes: 404
  
  # Transaction Tracer
  transaction_tracer:
    enabled: true
    transaction_threshold: apdex_f
    record_sql: obfuscated
    stack_trace_threshold: 0.5
  
  # Attributes Configuration - Ofuscación de datos sensibles
  attributes:
    enabled: true
    # Excluir atributos sensibles de todos los destinos
    exclude:
      # Excluir request.uri si contiene datos sensibles
      # - request.uri
    # Incluir solo atributos específicos
    include:
      - request.uri
      - request.method
      - response.status

  # Rules para ofuscar valores en atributos
  # Estas reglas aplican regex para ofuscar datos sensibles en URIs
  rules:
    # Regla para ofuscar DNI (8 dígitos) en URIs
    - name: "mask_dni_in_uri"
      match_expression: "/dni/([0-9]{8})(?:/|$|\\?)"
      replacement: "/dni/***MASKED***"
      enabled: true
      each_segment: false
      replace_all: true
      ignore: false

    # Regla para ofuscar emails en URIs
    - name: "mask_email_in_uri"
      match_expression: "/email/([^/]+@[^/]+)"
      replacement: "/email/***MASKED***"
      enabled: true
      each_segment: false
      replace_all: true
      ignore: false

  # Thread Profiler
  thread_profiler:
    enabled: true

prod:
  <<: *default_settings

dev:
  <<: *default_settings
  app_name: ms-order[dev]
  
qa:
  <<: *default_settings
  app_name: ms-order[qa]
